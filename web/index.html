<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Power Bank Rental</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="/">
    <script src="https://js.braintreegateway.com/web/3.91.0/js/client.min.js"></script>
    <script src="https://js.braintreegateway.com/web/3.91.0/js/apple-pay.min.js"></script>
    <!--    <script>-->
    <!--        function startApplePay(clientToken, callbackName) {-->
    <!--          braintree.client.create({ authorization: clientToken }, function (err, clientInstance) {-->
    <!--            if (err) return console.error(err);-->

    <!--            braintree.applePay.create({ client: clientInstance }, function (err, applePayInstance) {-->
    <!--              if (err) return console.error(err);-->

    <!--              const paymentRequest = applePayInstance.createPaymentRequest({-->
    <!--                total: { label: 'Recharge', amount: '4.99' },-->
    <!--                requiredBillingContactFields: ['postalAddress']-->
    <!--              });-->

    <!--              const session = new ApplePaySession(3, paymentRequest);-->

    <!--              session.onvalidatemerchant = function (event) {-->
    <!--                applePayInstance.performValidation({ validationURL: event.validationURL })-->
    <!--                  .then(data => session.completeMerchantValidation(data));-->
    <!--              };-->

    <!--              session.onpaymentauthorized = function (event) {-->
    <!--                applePayInstance.tokenize({ token: event.payment.token })-->
    <!--                  .then(payload => {-->
    <!--                    window.handleApplePayResult(payload.nonce);-->
    <!--                    session.completePayment(ApplePaySession.STATUS_SUCCESS);-->
    <!--                  });-->
    <!--              };-->

    <!--              session.begin();-->
    <!--            });-->
    <!--          });-->
    <!--        }-->
    <!--    </script>-->
</head>
<body>
<script src="flutter.js" defer></script>
<script src="flutter.js" defer></script>
<!--<script>-->
<!--    function startApplePay(clientToken) {-->
<!--      braintree.client.create({ authorization: clientToken }, (err, clientInstance) => {-->
<!--        if (err) return console.error(err);-->
<!--        braintree.applePay.create({ client: clientInstance }, (err, applePayInstance) => {-->
<!--          if (err) return console.error(err);-->

<!--          const paymentRequest = applePayInstance.createPaymentRequest({-->
<!--            total: { label: 'Recharge', amount: '4.99' },-->
<!--            countryCode: 'US',-->
<!--            currencyCode: 'USD',-->
<!--            supportedNetworks: ['amex','masterCard','visa'],-->
<!--            merchantCapabilities: ['supports3DS']-->
<!--          });-->

<!--          const session = new ApplePaySession(3, paymentRequest);-->

<!--          session.onvalidatemerchant = event => {-->
<!--            applePayInstance.performValidation({ validationURL: event.validationURL })-->
<!--              .then(merchantSession => session.completeMerchantValidation(merchantSession))-->
<!--              .catch(console.error);-->
<!--          };-->

<!--          session.onpaymentauthorized = event => {-->
<!--            applePayInstance.tokenize({ token: event.payment.token })-->
<!--              .then(payload => {-->
<!--                window.handleApplePayResult(payload.nonce);-->
<!--                session.completePayment(ApplePaySession.STATUS_SUCCESS);-->
<!--              })-->
<!--              .catch(err => {-->
<!--                console.error(err);-->
<!--                session.completePayment(ApplePaySession.STATUS_FAILURE);-->
<!--              });-->
<!--          };-->

<!--          session.begin();-->
<!--        });-->
<!--      });-->
<!--    }-->
<!--</script>-->
<script>
    function startApplePay(clientToken) {
      // 1. Create a Braintree client
      braintree.client.create({ authorization: clientToken }, function (err, clientInstance) {
        if (err) return console.error('Client error', err);

        // 2. Create the ApplePay component
        braintree.applePay.create({ client: clientInstance }, function (err, applePayInstance) {
          if (err) return console.error('ApplePay create error', err);

          // 3. Build the Apple Pay request
          const paymentRequest = applePayInstance.createPaymentRequest({
            countryCode: 'US',
            currencyCode: 'USD',
            total: { label: 'PowerBank Rental', amount: '4.99' },
            supportedNetworks: ['visa', 'masterCard', 'amex'],
            merchantCapabilities: ['supports3DS']
          });

          // 4. Launch the native Apple Pay sheet
          const session = new ApplePaySession(3, paymentRequest);

          // 5. Handle merchant validation using Braintree SDK
          session.onvalidatemerchant = event => {
            applePayInstance.performValidation({ validationURL: event.validationURL })
              .then(merchantSession => session.completeMerchantValidation(merchantSession))
              .catch(err => console.error('Validation error', err));
          };

          // 6. Handle payment authorization and tokenize
          session.onpaymentauthorized = event => {
            applePayInstance.tokenize({ token: event.payment.token })
              .then(payload => {
                // payload.nonce is your Braintree payment nonce
                window.handleApplePayResult(payload.nonce);
                session.completePayment(ApplePaySession.STATUS_SUCCESS);
              })
              .catch(err => {
                console.error('Tokenize error', err);
                session.completePayment(ApplePaySession.STATUS_FAILURE);
              });
          };

          session.begin();
        });
      });
    }
</script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
      if (window._flutter && window._flutter.loader) {
        window._flutter.loader.load();
      } else {
        console.error('Flutter loader not found');
      }
    });
</script>

</body>
</html>
